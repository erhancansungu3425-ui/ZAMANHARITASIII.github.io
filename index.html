<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Zaman HaritasÄ± â€” UnutulmuÅŸ Eserler</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
:root{
  --bg:#f6f8fb; --card:#fff; --accent:#0f766e; --muted:#56616b; --radius:12px;
}
*{box-sizing:border-box}
html,body,#app{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;background:var(--bg);color:#0f172a;font-size:15px}

/* Header */
header{display:flex;align-items:center;gap:12px;padding:12px 14px;background:linear-gradient(90deg,var(--accent),#06b6d4);color:#fff;position:sticky;top:0;z-index:2000}
.logo{width:46px;height:46px;border-radius:10px;background:rgba(255,255,255,0.12);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:18px}
.header-title h1{margin:0;font-size:18px}
.header-actions{margin-left:auto;display:flex;gap:8px;align-items:center}
.btn{padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,0.12);background:transparent;color:#fff;cursor:pointer;font-size:13px}
.btn.solid{background:#fff;color:var(--accent);border-color:transparent}

/* Layout */
.container{display:grid;grid-template-columns:360px 1fr;gap:12px;padding:12px;height:calc(100% - 72px)}
.sidebar{background:var(--card);border-radius:12px;padding:12px;box-shadow:0 10px 30px rgba(15,23,42,0.05);display:flex;flex-direction:column;gap:10px;overflow:auto}
.controls{display:flex;gap:8px;align-items:center}
.search input{width:100%;padding:10px;border-radius:10px;border:1px solid #e6e9ef;font-size:15px;background:#fbfdff}
.select{padding:9px;border-radius:8px;border:1px solid #e6e9ef;background:#fff;font-size:14px}
.list{display:flex;flex-direction:column;gap:8px;margin-top:6px}
.item{display:flex;gap:8px;align-items:flex-start;padding:8px;border-radius:10px;background:#fff;cursor:pointer}
.item:hover{transform:translateY(-2px);box-shadow:0 12px 24px rgba(15,23,42,0.04)}
.thumb{width:100px;height:64px;border-radius:8px;object-fit:cover;flex-shrink:0;background:#f0f0f0}
.meta h3{margin:0;font-size:14px}
.meta p{margin:6px 0 0;color:var(--muted);font-size:13px}
.star{font-size:18px;color:#cbd5e1;cursor:pointer}
.star.on{color:#f59e0b}

/* detail card */
.detail{background:#fbfdff;padding:10px;border-radius:10px;border:1px solid #eef2f6}
.detail img{width:100%;height:180px;object-fit:cover;border-radius:8px;margin-top:8px}
.comments{max-height:220px;overflow:auto;margin-top:8px}
.comment{padding:8px;border-radius:8px;border:1px solid #eef2f6;background:white;margin-top:8px}
.muted{color:var(--muted);font-size:13px}

/* map */
.map-wrap{border-radius:12px;box-shadow:0 10px 30px rgba(15,23,42,0.06);overflow:hidden;height:100%}
#map{width:100%;height:100%}

/* auth overlay */
.auth-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:flex;align-items:center;justify-content:center;z-index:4000}
.auth-card{background:#fff;border-radius:12px;padding:18px;width:92%;max-width:420px;box-shadow:0 30px 60px rgba(2,6,23,0.15)}
.auth-card h2{margin:0 0 8px 0}
.input{width:100%;padding:10px;border-radius:8px;border:1px solid #e6e9ef;margin-top:8px}
.small{font-size:13px;color:var(--muted)}

@media(max-width:920px){
  .container{grid-template-columns:1fr;padding:10px;height:calc(100% - 120px)}
  .sidebar{position:relative;max-height:46vh}
  #map{min-height:46vh}
}
</style>
</head>
<body>
<div id="app">
  <!-- AUTH OVERLAY -->
  <div class="auth-overlay" id="authOverlay" aria-hidden="false">
    <div class="auth-card" role="dialog" aria-modal="true">
      <div id="registerView">
        <h2>KayÄ±t Ol</h2>
        <input id="regUser" class="input" placeholder="KullanÄ±cÄ± adÄ±" />
        <input id="regPass" class="input" placeholder="Åžifre" type="password" />
        <label style="display:flex;gap:8px;align-items:center;margin-top:8px"><input type="checkbox" id="regRemember" /> Beni hatÄ±rla</label>
        <div style="display:flex;gap:8px;margin-top:12px">
          <button id="doRegister" class="btn solid" style="flex:1">KayÄ±t Ol</button>
          <button id="showLogin" class="btn" style="flex:1">HesabÄ±nÄ±z var mÄ±?</button>
        </div>
      </div>

      <div id="loginView" style="display:none">
        <h2>GiriÅŸ Yap</h2>
        <input id="logUser" class="input" placeholder="KullanÄ±cÄ± adÄ±" />
        <input id="logPass" class="input" placeholder="Åžifre" type="password" />
        <label style="display:flex;gap:8px;align-items:center;margin-top:8px"><input type="checkbox" id="logRemember" /> Beni hatÄ±rla</label>
        <div style="display:flex;gap:8px;margin-top:12px">
          <button id="doLogin" class="btn solid" style="flex:1">GiriÅŸ Yap</button>
          <button id="showRegister" class="btn" style="flex:1">KayÄ±t Ol</button>
        </div>
      </div>
    </div>
  </div>

  <!-- HEADER -->
  <header>
    <div class="logo">Z</div>
    <div class="header-title">
      <h1>Zaman HaritasÄ±</h1>
      <div class="small">UnutulmuÅŸ eserleri keÅŸfet â€” beÄŸen, yorumla, indir</div>
    </div>
    <div class="header-actions" role="region" aria-label="KullanÄ±cÄ±">
      <div id="welcomeBox" style="text-align:right">
        <div id="welcomeText" style="font-weight:700">GiriÅŸ yapÄ±lmadÄ±</div>
        <div id="welcomeSub" class="small">LÃ¼tfen giriÅŸ yapÄ±n</div>
      </div>
      <button id="logoutBtn" class="btn" style="display:none">Ã‡Ä±kÄ±ÅŸ</button>
      <button id="favFilterBtn" class="btn">Sadece BeÄŸendiklerim</button>
      <button id="fitAllBtn" class="btn">Hepsini GÃ¶ster</button>
    </div>
  </header>

  <!-- MAIN -->
  <div class="container" role="main">
    <aside class="sidebar" aria-label="Mekan listesi">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>Mekanlar</strong><div class="small">Listeden seÃ§im yapÄ±n</div></div>
        <div class="small"><span id="count">25</span> nokta</div>
      </div>

      <div class="controls" style="margin-top:8px">
        <div style="flex:1" class="search"><input id="searchInput" placeholder="Ara: isim, ÅŸehir veya anahtar kelime..." /></div>
        <select id="citySelect" class="select" title="Åžehir seÃ§"><option value="all">TÃ¼m Åžehirler</option></select>
      </div>

      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="clearFiltersBtn" class="btn">Temizle</button>
      </div>

      <!-- Detail -->
      <div id="detailCard" class="detail" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div id="detailName" style="font-weight:700"></div>
            <div id="detailCity" class="small" style="color:var(--muted)"></div>
          </div>
          <div>
            <button id="detailFavBtn" class="btn">â˜† BeÄŸen</button>
          </div>
        </div>
        <img id="detailImage" src="" alt="">
        <p id="detailDesc" class="small" style="margin-top:8px"></p>
        <div style="display:flex;gap:8px;margin-top:8px">
          <a id="detailBook" class="btn solid" href="#" target="_blank">ðŸ“– KitabÄ± Ä°ndir</a>
          <button id="detailNav" class="btn">Navigasyon</button>
        </div>

        <hr style="margin-top:12px">

        <div>
          <h4 style="margin:0">Yorumlar</h4>
          <div id="commentsList" class="comments"></div>

          <textarea id="commentInput" placeholder="Yorum yaz..." style="width:100%;min-height:70px;padding:8px;border-radius:8px;border:1px solid #e6e9ef;margin-top:8px"></textarea>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="postCommentBtn" class="btn solid">GÃ¶nder</button>
            <div id="commentStatus" class="small" style="align-self:center"></div>
          </div>
        </div>
      </div>

      <!-- list -->
      <div class="list" id="placesList" aria-live="polite" style="margin-top:8px"></div>

      <footer style="margin-top:auto" class="sidefoot">
        <small id="sourceNote">KaynakÃ§a: TÃ¼rkiye KÃ¼ltÃ¼r ve Turizm, Wikimedia Commons, yerel kaynaklar.</small>
        <small style="color:var(--accent);font-weight:700">EUO TECH</small>
      </footer>
    </aside>

    <main class="map-wrap">
      <div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:rgba(255,255,255,0.6)">
        <div style="font-weight:700">TÃ¼rkiye â€” UnutulmuÅŸ Eserler HaritasÄ±</div>
        <div>
          <button id="zoomInBtn" class="btn">+</button>
          <button id="zoomOutBtn" class="btn">âˆ’</button>
        </div>
      </div>
      <div id="map" aria-label="Harita"></div>
    </main>
  </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
/* ========== PLACES (25) ========== 
Files must match exactly and be in same folder as index.html
======================================*/
const PLACES = [
  {id:'P01', name:'AlacahÃ¶yÃ¼k', city:'Ã‡orum', coords:[40.0015,34.5539], desc:'TÃ¼rkiyeâ€™nin erken demir Ã§aÄŸÄ± merkezlerinden; Hitit ve Ã¶ncesi kalÄ±ntÄ±lar.', image:'alacahoyuk.jpg'},
  {id:'P02', name:'Alahan ManastÄ±rÄ±', city:'Karaman', coords:[37.0673,32.6346], desc:'Erken dÃ¶nem hristiyan manastÄ±r kompleksi.', image:'alahanmanastiri.jpg'},
  {id:'P03', name:'Aizonai', city:'UÅŸak', coords:[38.6733,29.7650], desc:'Antik kent ve agora kalÄ±ntÄ±larÄ±.', image:'aizonai.jpg'},
  {id:'P04', name:'Alanya Kalesi', city:'Antalya', coords:[36.5486,32.0165], desc:'Tarihi kale ve liman manzaralarÄ±.', image:'alanya_kalesi.jpg'},
  {id:'P05', name:'Ani Harabeleri', city:'Kars', coords:[40.5070,43.5720], desc:'OrtaÃ§aÄŸ kent kalÄ±ntÄ±larÄ±; sÄ±nÄ±r Ã¶tesi tarihin izleri.', image:'ani_harabeleri.jpg'},
  {id:'P06', name:'Arsemia', city:'KahramanmaraÅŸ', coords:[37.1710,36.9465], desc:'Tarihi yerleÅŸim ve kayalara oyulmuÅŸ kalÄ±ntÄ±lar.', image:'arsemia.jpg'},
  {id:'P07', name:'Aspendos', city:'Antalya', coords:[36.9383,31.1761], desc:'Roma dÃ¶nemi tiyatrosu; akustiÄŸi ile meÅŸhur.', image:'aspendos.jpg'},
  {id:'P08', name:'Assos', city:'Ã‡anakkale', coords:[39.3700,26.0811], desc:'Antik liman kenti ve felsefi merkez.', image:'assos.jpg'},
  {id:'P09', name:'Bodrum Kalesi', city:'MuÄŸla', coords:[37.0344,27.4305], desc:'SualtÄ± arkeoloji mÃ¼zesine ev sahipliÄŸi yapan kale.', image:'bodrumkalesi.jpg'},
  {id:'P10', name:'Ã‡atalhÃ¶yÃ¼k', city:'Konya', coords:[37.6670,32.8260], desc:'Neolitik dÃ¶nem topluluk yerleÅŸimi; erken mimari Ã¶rnekleri.', image:'catalhoyuk.jpg'},
  {id:'P11', name:'Efes', city:'Ä°zmir', coords:[37.9410,27.3416], desc:'Celsus kÃ¼tÃ¼phanesi ve bÃ¼yÃ¼k liman kenti kalÄ±ntÄ±larÄ±.', image:'efes.jpg'},
  {id:'P12', name:'GÃ¶bekli Tepe', city:'ÅžanlÄ±urfa', coords:[37.2231,38.9226], desc:'DÃ¼nyanÄ±n bilinen en eski tapÄ±naÄŸÄ±; anÄ±tsal taÅŸlar.', image:'gobeklitepe.jpg'},
  {id:'P13', name:'Hasankeyf', city:'Batman', coords:[37.8786,41.1241], desc:'Dicle kÄ±yÄ±sÄ±nda Ã§ok katmanlÄ± arkeolojik yerleÅŸim; maÄŸara ve kalÄ±ntÄ±lar.', image:'hasankeyf.jpg'},
  {id:'P14', name:'HattuÅŸa', city:'Ã‡orum', coords:[40.0217,34.6152], desc:'Hitit Ä°mparatorluÄŸuâ€™nun baÅŸkenti; tapÄ±naklar ve surlar.', image:'hattusa.jpg'},
  {id:'P15', name:'Hierapolis', city:'Denizli', coords:[37.9241,29.1180], desc:'Beyaz travertenlerin yanÄ±nda antik kent kalÄ±ntÄ±larÄ±.', image:'hierapolis.jpg'},
  {id:'P16', name:'KaniÅŸ-Karum (Kaniskarum)', city:'KÄ±rÅŸehir', coords:[39.6827,34.1220], desc:'Ticaret kolonisi ve antik kazÄ± alanlarÄ±.', image:'kaniskarum.jpg'},
  {id:'P17', name:'Myra', city:'Antalya', coords:[36.2681,29.0987], desc:'Likya dÃ¶nemi kaya mezarlarÄ± ve antik liman kenti.', image:'myra.jpg'},
  {id:'P18', name:'Nemrut DaÄŸÄ±', city:'AdÄ±yaman', coords:[37.9845,38.7445], desc:'Kommagene kral mezar tepesi; dev heykeller.', image:'nemrut.jpg'},
  {id:'P19', name:'Pamukkale', city:'Denizli', coords:[37.9241,29.1180], desc:'Termal su kaynaklarÄ±nÄ±n oluÅŸturduÄŸu traverten teraslar ve Hierapolis.', image:'pamukkale.jpg'},
  {id:'P20', name:'Pergamon (Pergamon)', city:'Ä°zmir', coords:[39.1200,27.1830], desc:'Akropol ve Asklepion kalÄ±ntÄ±larÄ±.', image:'pergamon.jpg'},
  {id:'P21', name:'Phaselis', city:'Antalya', coords:[36.5150,30.5590], desc:'Antik liman kenti; gÃ¼zel koylarÄ±yla bilinir.', image:'phaselis.jpg'},
  {id:'P22', name:'Sagalassos', city:'Burdur', coords:[37.6760,30.5260], desc:'YÃ¼ksek rakÄ±mlÄ± antik kent ve tiyatro.', image:'sagalassos.jpg'},
  {id:'P23', name:'SÃ¼mela ManastÄ±rÄ±', city:'Trabzon', coords:[40.7114,39.7172], desc:'DaÄŸ yamacÄ±na oyulmuÅŸ manastÄ±r kompleksi.', image:'sumela.jpg'},
  {id:'P24', name:'Side Antik Kenti', city:'Antalya', coords:[36.7781,31.3815], desc:'Antik tiyatro ve liman kalÄ±ntÄ±larÄ±.', image:'sideantikkenti.jpg'},
  {id:'P25', name:'Tralleis', city:'AydÄ±n', coords:[37.8550,27.8433], desc:'Antik kent kalÄ±ntÄ±larÄ±; tarihÃ® eserler.', image:'tralleis.jpg'}
];

/* ========== Storage helpers ========== */
function loadUsers(){ try{ return JSON.parse(localStorage.getItem('zh_users')||'{}'); }catch(e){return{}} }
function saveUsers(u){ localStorage.setItem('zh_users', JSON.stringify(u)); }
function loadComments(){ try{ return JSON.parse(localStorage.getItem('zh_comments')||'{}'); }catch(e){return{}} }
function saveComments(c){ localStorage.setItem('zh_comments', JSON.stringify(c)); }
function setRemember(u){ localStorage.setItem('zh_remember', u); }
function clearRemember(){ localStorage.removeItem('zh_remember'); }
function getRemember(){ return localStorage.getItem('zh_remember') || null; }

/* SHA-256 helper for password hashing */
async function hashStr(str){
  const enc = new TextEncoder();
  const data = enc.encode(str);
  const buf = await crypto.subtle.digest('SHA-256', data);
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}

/* Profanity list and check */
const PROFANITY = ['orospu','piÃ§','pezevenk','siktir','anan','amk','yarrak','gÃ¶t','kahbe','oÃ§','sik'];
function containsProfanity(text){
  if(!text) return false;
  const t = text.toLowerCase();
  return PROFANITY.some(w => t.includes(w));
}

/* App state & refs */
let currentUser = null;
let map = null;
let markers = [];
let showingFavsOnly = false;
let selectedPlace = null;

const authOverlay = document.getElementById('authOverlay');
const registerView = document.getElementById('registerView');
const loginView = document.getElementById('loginView');
const regUser = document.getElementById('regUser');
const regPass = document.getElementById('regPass');
const regRemember = document.getElementById('regRemember');
const doRegister = document.getElementById('doRegister');
const showLogin = document.getElementById('showLogin');

const logUser = document.getElementById('logUser');
const logPass = document.getElementById('logPass');
const logRemember = document.getElementById('logRemember');
const doLogin = document.getElementById('doLogin');
const showRegister = document.getElementById('showRegister');

const welcomeText = document.getElementById('welcomeText');
const welcomeSub = document.getElementById('welcomeSub');
const logoutBtn = document.getElementById('logoutBtn');
const favFilterBtn = document.getElementById('favFilterBtn');
const fitAllBtn = document.getElementById('fitAllBtn');

const citySelect = document.getElementById('citySelect');
const placesListEl = document.getElementById('placesList');
const countEl = document.getElementById('count');
const searchInput = document.getElementById('searchInput');
const detailCard = document.getElementById('detailCard');
const detailName = document.getElementById('detailName');
const detailCity = document.getElementById('detailCity');
const detailImage = document.getElementById('detailImage');
const detailDesc = document.getElementById('detailDesc');
const detailFavBtn = document.getElementById('detailFavBtn');
const detailBook = document.getElementById('detailBook');
const detailNav = document.getElementById('detailNav');
const commentsList = document.getElementById('commentsList');
const commentInput = document.getElementById('commentInput');
const postCommentBtn = document.getElementById('postCommentBtn');
const commentStatus = document.getElementById('commentStatus');
const clearFiltersBtn = document.getElementById('clearFiltersBtn');
const zoomInBtn = document.getElementById('zoomInBtn');
const zoomOutBtn = document.getElementById('zoomOutBtn');

/* ---------- AUTH handlers ---------- */
showLogin.addEventListener('click', ()=>{ registerView.style.display='none'; loginView.style.display='block'; });
showRegister.addEventListener('click', ()=>{ registerView.style.display='block'; loginView.style.display='none'; });

doRegister.addEventListener('click', async ()=>{
  const u = (regUser.value||'').trim();
  const p = (regPass.value||'').trim();
  const rem = regRemember.checked;
  if(!u || !p){ alert('KullanÄ±cÄ± adÄ± ve ÅŸifre girin.'); return; }
  const users = loadUsers();
  if(users[u]){ alert('Bu kullanÄ±cÄ± zaten kayÄ±tlÄ±.'); return; }
  const passHash = await hashStr(p);
  users[u] = { passHash, favorites:[], warnings:0, banned:false };
  saveUsers(users);
  currentUser = u;
  if(rem) setRemember(u);
  authOverlay.style.display = 'none';
  ensureUserAndStart();
});

doLogin.addEventListener('click', async ()=>{
  const u = (logUser.value||'').trim();
  const p = (logPass.value||'').trim();
  const rem = logRemember.checked;
  if(!u || !p){ alert('KullanÄ±cÄ± adÄ± ve ÅŸifre girin.'); return; }
  const users = loadUsers();
  if(!users[u]){ alert('KullanÄ±cÄ± bulunamadÄ±. KayÄ±t olun.'); return; }
  if(users[u].banned){ alert('HesabÄ±nÄ±z yasaklÄ±.'); return; }
  const passHash = await hashStr(p);
  if(passHash !== users[u].passHash){ alert('Åžifre hatalÄ±.'); return; }
  currentUser = u;
  if(rem) setRemember(u); else clearRemember();
  authOverlay.style.display = 'none';
  ensureUserAndStart();
});

/* auto-remember */
(function autoRemember(){
  const r = getRemember();
  const users = loadUsers();
  if(r && users[r] && !users[r].banned){
    currentUser = r;
    authOverlay.style.display = 'none';
    ensureUserAndStart();
  } else {
    authOverlay.style.display = 'flex';
  }
})();

logoutBtn.addEventListener('click', ()=>{
  if(!confirm('Ã‡Ä±kÄ±ÅŸ yapmak istiyor musunuz?')) return;
  currentUser = null;
  clearRemember();
  authOverlay.style.display = 'flex';
  updateWelcome();
});

/* ensure user structure */
function ensureUserAndStart(){
  const users = loadUsers();
  if(!currentUser) return;
  if(!users[currentUser]) users[currentUser] = { passHash:'', favorites:[], warnings:0, banned:false };
  saveUsers(users);
  updateWelcome();
  if(!map) initMap();
  renderPlaces();
}

/* update welcome UI */
function updateWelcome(){
  if(currentUser){
    welcomeText.innerText = 'HoÅŸgeldin, ' + currentUser;
    welcomeSub.innerText = 'BeÄŸendiklerin ve yorumlarÄ±n kaydediliyor';
    logoutBtn.style.display = 'inline-block';
  } else {
    welcomeText.innerText = 'GiriÅŸ yapÄ±lmadÄ±';
    welcomeSub.innerText = 'LÃ¼tfen giriÅŸ yapÄ±n';
    logoutBtn.style.display = 'none';
  }
}

/* ---------- Map & UI ---------- */
function initMap(){
  map = L.map('map', {tap:true}).setView([39.0,35.0],5);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19, attribution:'Â© OpenStreetMap contributors'}).addTo(map);
  renderPlaces();
}

/* build city options */
(function buildCities(){
  const cities = Array.from(new Set(PLACES.map(p=>p.city))).sort((a,b)=>a.localeCompare(b,'tr'));
  cities.forEach(c=>{
    const opt = document.createElement('option'); opt.value = c; opt.innerText = c;
    citySelect.appendChild(opt);
  });
})();

let activeCity = 'all';
let searchQuery = '';
citySelect.addEventListener('change', ()=>{ activeCity = citySelect.value; renderPlaces(); });
searchInput.addEventListener('input', ()=>{ searchQuery = searchInput.value.trim().toLowerCase(); renderPlaces(); });
favFilterBtn.addEventListener('click', ()=>{ showingFavsOnly = !showingFavsOnly; favFilterBtn.innerText = showingFavsOnly ? 'TÃ¼mÃ¼nÃ¼ GÃ¶ster' : 'Sadece BeÄŸendiklerim'; renderPlaces(); });
clearFiltersBtn.addEventListener('click', ()=>{ activeCity='all'; citySelect.value='all'; searchQuery=''; searchInput.value=''; showingFavsOnly=false; favFilterBtn.innerText='Sadece BeÄŸendiklerim'; renderPlaces(); });
fitAllBtn.addEventListener('click', ()=>{ const bounds = PLACES.map(p=>p.coords); if(bounds.length) map.fitBounds(bounds,{padding:[60,60]}); });
zoomInBtn.addEventListener('click', ()=>map.zoomIn());
zoomOutBtn.addEventListener('click', ()=>map.zoomOut());

/* favorites helpers */
function getFavorites(){
  const users = loadUsers();
  if(!currentUser || !users[currentUser]) return [];
  return users[currentUser].favorites || [];
}
function toggleFavorite(placeId){
  if(!currentUser){ alert('Favorilere eklemek iÃ§in giriÅŸ yapÄ±n.'); return; }
  const users = loadUsers();
  users[currentUser] = users[currentUser] || {passHash:'',favorites:[],warnings:0,banned:false};
  users[currentUser].favorites = users[currentUser].favorites || [];
  if(users[currentUser].favorites.includes(placeId)) users[currentUser].favorites = users[currentUser].favorites.filter(x=>x!==placeId);
  else users[currentUser].favorites.push(placeId);
  saveUsers(users);
  renderPlaces();
}

/* comments helpers */
function getCommentsFor(placeId){
  const all = loadComments();
  return all[placeId] || [];
}
function addCommentFor(placeId, user, text){
  const all = loadComments();
  all[placeId] = all[placeId] || [];
  all[placeId].push({user, text, time: Date.now()});
  saveComments(all);
}

/* moderation: warnings and ban after 3 warnings */
function registerWarning(username){
  const users = loadUsers();
  users[username] = users[username] || {passHash:'',favorites:[],warnings:0,banned:false};
  users[username].warnings = (users[username].warnings || 0) + 1;
  if(users[username].warnings >= 3){
    users[username].banned = true;
    alert('3 uyarÄ± alÄ±ndÄ± â€” hesap yasaklandÄ±.');
  } else {
    alert('UyarÄ±: uygunsuz iÃ§erik tespit edildi. UyarÄ± sayÄ±nÄ±z: ' + users[username].warnings);
  }
  saveUsers(users);
}

/* render list and markers */
function clearMarkers(){ markers.forEach(m=>map.removeLayer(m)); markers=[]; }
function renderPlaces(){
  placesListEl.innerHTML = '';
  clearMarkers();
  const users = loadUsers();
  let list = PLACES.filter(p=>{
    if(activeCity !== 'all' && p.city !== activeCity) return false;
    if(searchQuery){
      const s = searchQuery;
      if(!(p.name.toLowerCase().includes(s) || p.city.toLowerCase().includes(s) || p.desc.toLowerCase().includes(s))) return false;
    }
    if(showingFavsOnly && currentUser){
      const favs = getFavorites();
      if(!favs.includes(p.id)) return false;
    }
    return true;
  });
  countEl.innerText = list.length;
  const bounds = [];
  list.forEach(p=>{
    const item = document.createElement('div'); item.className='item';
    const favs = currentUser ? getFavorites() : [];
    const isFav = favs.includes(p.id);
    item.innerHTML = `
      <img class="thumb" src="${p.image}" alt="${p.name}" onerror="this.onerror=null;this.src='placeholder.jpg'">
      <div class="meta" style="flex:1">
        <h3>${p.name} <span style="font-size:12px;color:#94a3b8">â€¢ ${p.city}</span></h3>
        <p>${p.desc}</p>
      </div>
      <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px">
        <div class="star ${isFav?'on':''}" data-id="${p.id}" title="Favori">${isFav?'â˜…':'â˜†'}</div>
      </div>
    `;
    item.addEventListener('click', ()=> { openDetail(p); map.setView(p.coords, 11, {animate:true}); });
    item.querySelector('.star').addEventListener('click', e=>{ e.stopPropagation(); toggleFavorite(p.id); });
    placesListEl.appendChild(item);

    const m = L.marker(p.coords).addTo(map).bindPopup(`<b>${p.name}</b><div style="font-size:12px;color:#556">${p.city}</div>`);
    m.on('click', ()=> { openDetail(p); map.setView(p.coords, 11, {animate:true}); });
    markers.push(m);
    bounds.push(p.coords);
  });
  if(bounds.length) map.fitBounds(bounds, {padding:[60,60]});
}

/* open detail in sidebar for a place */
function openDetail(p){
  selectedPlace = p;
  detailCard.style.display = 'block';
  detailName.innerText = p.name;
  detailCity.innerText = p.city;
  detailImage.src = p.image;
  detailImage.onerror = ()=> detailImage.src = 'placeholder.jpg';
  detailDesc.innerText = p.desc;
  detailBook.href = `books/${p.id}.pdf`;
  // fav button text
  const favs = currentUser ? getFavorites() : [];
  detailFavBtn.innerText = favs.includes(p.id) ? 'â˜… BeÄŸenden KaldÄ±r' : 'â˜† BeÄŸen';
  // comments
  renderCommentsUI(p.id);
}

/* render comments for a place */
function renderCommentsUI(placeId){
  commentsList.innerHTML = '';
  const arr = getCommentsFor(placeId);
  if(!arr.length) commentsList.innerHTML = '<div class="small" style="color:var(--muted)">HenÃ¼z yorum yok.</div>';
  arr.slice().reverse().forEach(c=>{
    const el = document.createElement('div'); el.className='comment';
    el.innerHTML = `<strong>${escapeHtml(c.user)}</strong> <span class="small" style="color:var(--muted)">â€¢ ${new Date(c.time).toLocaleString()}</span><div style="margin-top:6px">${escapeHtml(c.text)}</div>`;
    commentsList.appendChild(el);
  });
}

/* post comment */
postCommentBtn.addEventListener('click', ()=>{
  if(!currentUser){ alert('Yorum eklemek iÃ§in giriÅŸ yapÄ±n.'); return; }
  if(!selectedPlace){ alert('LÃ¼tfen bir mekan seÃ§in.'); return; }
  const text = (commentInput.value||'').trim();
  if(!text){ alert('Yorum boÅŸ olamaz.'); return; }
  if(containsProfanity(text)){
    registerWarning(currentUser);
    commentStatus.innerText = 'Uygunsuz iÃ§erik tespit edildi ve kaydedilmedi.';
    commentInput.value = '';
    if(loadUsers()[currentUser] && loadUsers()[currentUser].banned){
      alert('HesabÄ±nÄ±z yasaklandÄ±.');
      currentUser = null;
      updateWelcome();
      authOverlay.style.display = 'flex';
    }
    return;
  }
  addCommentFor(selectedPlace.id, currentUser, text);
  commentInput.value = '';
  renderCommentsUI(selectedPlace.id);
  commentStatus.innerText = 'Yorum gÃ¶nderildi.';
  setTimeout(()=> commentStatus.innerText = '', 2500);
});

/* utility escape */
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<"'>]/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]; }); }

/* init */
window.addEventListener('load', ()=>{
  updateWelcome();
  const rem = getRemember();
  const users = loadUsers();
  if(rem && users[rem] && !users[rem].banned){
    currentUser = rem;
    authOverlay.style.display = 'none';
    ensureUserAndStart();
  } else {
    authOverlay.style.display = 'flex';
  }
  if(!map) initMap();
});
</script>
</body>
</html>
